# ラーメンアプリ機能拡張 実装計画書

## 📋 プロジェクト概要

### 目的
ユーザーエンゲージメント向上のため、以下2つの機能を実装する：
1. **検索・フィルタ機能の拡張**
2. **通知機能の充実**

### 技術スタック
- **フロントエンド**: Next.js 16, React 19, TypeScript
- **バックエンド**: Convex (BaaS)
- **認証**: Clerk
- **UI**: Radix UI, Tailwind CSS

### 実装期間
並行開発により1日での完成を目指す

---

## 🎯 機能1: 検索・フィルタ機能の拡張

### 現状分析
- ✅ 基本的な検索・フィルタは実装済み (`src/app/(main)/noodles/page.tsx:32-45`)
- ✅ ジャンル、店名・メニュー名検索、ソート機能あり
- ❌ 都道府県フィルタ未実装
- ❌ 評価（星）でのフィルタ未実装
- ❌ 訪問日期間フィルタ未実装
- ❌ 保存した検索条件機能なし
- ❌ マイページでの検索・フィルタ機能なし

### 実装タスク

#### タスク1.1: バックエンド - 拡張フィルタクエリ実装
**担当**: Agent-Backend-1
**ファイル**: `convex/noodles.ts`
**作業内容**:
1. `list` クエリに以下のパラメータを追加:
   - `prefectures?: string[]` - 都道府県フィルタ
   - `minRating?: number` - 最低評価フィルタ
   - `maxRating?: number` - 最高評価フィルタ
   - `dateFrom?: number` - 訪問日開始
   - `dateTo?: number` - 訪問日終了

2. `getByUser` クエリにも同様のフィルタパラメータを追加

3. フィルタロジックの実装（既存の76-95行目を拡張）

**必要な知識**:
- `convex/schema.ts`: スキーマ構造
- `convex/noodles.ts:21-149`: 既存のlistクエリ実装

**完了条件**:
- [ ] 都道府県フィルタが動作する
- [ ] 評価範囲フィルタが動作する
- [ ] 日付範囲フィルタが動作する
- [ ] 複数フィルタの組み合わせが正しく動作する

---

#### タスク1.2: フロントエンド - 拡張フィルタUI実装（タイムライン）
**担当**: Agent-Frontend-1
**ファイル**: `src/app/(main)/noodles/page.tsx`
**作業内容**:
1. フィルタ状態の追加:
   ```typescript
   const [selectedPrefectures, setSelectedPrefectures] = useState<string[]>([]);
   const [minRating, setMinRating] = useState<number | undefined>();
   const [maxRating, setMaxRating] = useState<number | undefined>();
   const [dateRange, setDateRange] = useState<{from?: Date, to?: Date}>({});
   ```

2. フィルタUIコンポーネントの拡張（149-217行目を拡張）:
   - 都道府県選択（既存の `prefecture-select.tsx` を活用）
   - 評価フィルタ（スライダーまたはボタン）
   - 日付範囲選択（シンプルなdate input）

3. クエリパラメータの更新（40-47行目）

**依存コンポーネント**:
- `src/components/ui/prefecture-select.tsx`: 既存
- `src/lib/constants/prefectures.ts`: 都道府県定義（要確認、なければ作成）

**完了条件**:
- [ ] 都道府県フィルタUIが動作する
- [ ] 評価フィルタUIが動作する
- [ ] 日付範囲フィルタUIが動作する
- [ ] フィルタクリアボタンですべてリセットされる
- [ ] URLパラメータでフィルタ状態が保存される（オプション）

---

#### タスク1.3: フロントエンド - マイページ検索機能追加
**担当**: Agent-Frontend-2
**ファイル**: `src/app/(main)/page.tsx`
**作業内容**:
1. マイページ（ホーム）の「啜ったラーメン」セクション（368-433行目）に検索・フィルタUIを追加

2. リスト表示時のみフィルタ表示（ギャラリービューは既存維持）

3. 簡易版フィルタ実装:
   - テキスト検索（店名・メニュー名）
   - ジャンルフィルタ
   - 評価フィルタ

4. Convexクエリ `getByUser` の拡張パラメータ利用

**依存関係**:
- タスク1.1完了後に着手可能

**完了条件**:
- [ ] マイページで自分の投稿を検索できる
- [ ] リスト/ギャラリービューの切り替えが正常動作
- [ ] フィルタクリアが正しく動作する

---

#### タスク1.4: 保存検索条件機能（オプション）
**担当**: Agent-Backend-2
**ファイル**: 新規 `convex/savedSearches.ts`
**作業内容**:
1. スキーマ追加 (`convex/schema.ts`):
```typescript
savedSearches: defineTable({
  userId: v.id("users"),
  name: v.string(), // "東京の醤油ラーメン"
  filters: v.string(), // JSON化したフィルタ条件
  createdAt: v.number(),
}).index("by_userId", ["userId"]),
```

2. CRUD操作実装:
   - `create`: 検索条件を保存
   - `list`: ユーザーの保存済み検索一覧
   - `delete`: 検索条件を削除

3. フロントエンドで呼び出し可能な状態にする

**完了条件**:
- [ ] 検索条件を保存できる
- [ ] 保存した検索条件を一覧表示できる
- [ ] 保存した検索条件をワンクリックで適用できる

---

## 🔔 機能2: 通知機能の充実

### 現状分析
- ✅ 通知テーブル実装済み (`convex/schema.ts:115-127`)
- ✅ 基本的なCRUD操作実装済み (`convex/notifications.ts`)
- ❌ 通知UI未実装
- ❌ 自動通知生成未実装（いいね、コメント、フォロー時）
- ❌ 未読バッジ表示なし
- ❌ リアルタイム通知なし

### 実装タスク

#### タスク2.1: バックエンド - 通知自動生成実装
**担当**: Agent-Backend-3
**ファイル**:
- `convex/likes.ts`
- `convex/comments.ts`
- `convex/follows.ts`

**作業内容**:
1. `likes.ts` の `toggle` mutation（既存）に通知生成処理を追加:
   - いいね時: 投稿者に通知作成
   - いいね解除時: 通知は削除しない（履歴として残す）

2. `comments.ts` の `create` mutation に通知生成処理を追加:
   - コメント時: 投稿者に通知作成

3. `follows.ts` に通知生成処理を追加:
   - フォロー時: フォローされた人に通知作成
   - フォローリクエスト承認時: リクエスト者に通知作成

4. 通知メッセージのテンプレート定義

**重要**: 自分への通知は作成しない（既存の `notifications.ts:59-61` を参照）

**必要な知識**:
- `convex/notifications.ts:50-72`: 通知作成ロジック
- `convex/likes.ts`, `convex/comments.ts`, `convex/follows.ts`: 既存のmutation

**完了条件**:
- [ ] いいね時に通知が作成される
- [ ] コメント時に通知が作成される
- [ ] フォロー時に通知が作成される
- [ ] 自分への通知は作成されない

---

#### タスク2.2: フロントエンド - 通知センターUI実装
**担当**: Agent-Frontend-3
**ファイル**:
- 新規 `src/app/(main)/notifications/page.tsx`
- 新規 `src/components/features/notification-list.tsx`

**作業内容**:
1. 通知一覧ページ作成:
   - 通知カードコンポーネント
   - 未読/既読表示
   - 通知タイプ別アイコン
   - タップで該当ページに遷移
   - 全て既読ボタン

2. 通知の種類別表示:
   - `like`: 「◯◯さんがあなたの投稿にいいねしました」
   - `comment`: 「◯◯さんがコメントしました」
   - `follow`: 「◯◯さんがあなたをフォローしました」
   - `follow_request`: 「◯◯さんからフォローリクエストが届きました」
   - `follow_approved`: 「フォローリクエストが承認されました」
   - `admin_announcement`: 管理者からのお知らせ

3. Convexクエリ利用:
   - `api.notifications.getByUser`: 通知一覧取得
   - `api.notifications.getUnreadCount`: 未読数取得
   - `api.notifications.markAllAsRead`: 全既読
   - `api.notifications.markAsRead`: 個別既読

**デザイン参考**:
- `src/components/features/noodle-card.tsx`: カードデザイン
- `src/app/(main)/follow-requests/page.tsx`: リクエスト一覧デザイン

**完了条件**:
- [ ] 通知一覧が表示される
- [ ] 未読通知がハイライトされる
- [ ] 通知をタップで該当ページに遷移
- [ ] 全て既読ボタンが動作する

---

#### タスク2.3: フロントエンド - ヘッダー通知バッジ実装
**担当**: Agent-Frontend-4
**ファイル**: `src/components/layout/header.tsx`
**作業内容**:
1. ヘッダーに通知アイコン追加（ベルアイコン）

2. 未読数バッジ表示:
   - `api.notifications.getUnreadCount` を利用
   - 未読数が0の場合はバッジ非表示
   - 未読数が10以上の場合は「9+」表示

3. アイコンクリックで `/notifications` に遷移

4. 新着通知時のアニメーション（脈打つ、色が変わるなど）

**必要な知識**:
- `src/components/layout/header.tsx`: 既存ヘッダー実装
- `lucide-react`: アイコンライブラリ（`Bell` アイコン使用）

**完了条件**:
- [ ] ヘッダーに通知アイコンが表示される
- [ ] 未読数バッジが正しく表示される
- [ ] アイコンクリックで通知ページに遷移

---

#### タスク2.4: フロントエンド - リアルタイム通知ポップアップ（オプション）
**担当**: Agent-Frontend-5
**ファイル**:
- 新規 `src/components/features/notification-toast.tsx`
- `src/app/(main)/layout.tsx`

**作業内容**:
1. トースト通知コンポーネント作成:
   - 画面右上に表示
   - 3秒後に自動消去
   - クリックで該当ページに遷移

2. Convexのリアルタイム機能を活用:
   - `useQuery` で通知を監視
   - 新着通知を検出したらトースト表示

3. レイアウトに組み込み

**完了条件**:
- [ ] 新着通知時にトーストが表示される
- [ ] トーストが自動で消える
- [ ] トーストクリックで該当ページに遷移

---

## 🔗 タスク依存関係図

```
機能1: 検索・フィルタ拡張
├─ タスク1.1 (Backend-1) ← 最優先
│   ├─ タスク1.2 (Frontend-1) ← 1.1完了後
│   └─ タスク1.3 (Frontend-2) ← 1.1完了後
└─ タスク1.4 (Backend-2) ← オプション、1.1と並行可

機能2: 通知機能充実
├─ タスク2.1 (Backend-3) ← 最優先
│   ├─ タスク2.2 (Frontend-3) ← 2.1完了後
│   ├─ タスク2.3 (Frontend-4) ← 2.1完了後
│   └─ タスク2.4 (Frontend-5) ← オプション、2.2/2.3と並行可
```

**並行実行可能**:
- タスク1.1 + タスク2.1（同時実行）
- タスク1.2 + タスク1.3（1.1完了後に同時実行）
- タスク2.2 + タスク2.3（2.1完了後に同時実行）

---

## 📁 ファイル構成

### 新規作成ファイル
```
convex/
├── savedSearches.ts                    # タスク1.4

src/
├── app/
│   └── (main)/
│       └── notifications/
│           └── page.tsx                 # タスク2.2
└── components/
    └── features/
        ├── notification-list.tsx        # タスク2.2
        └── notification-toast.tsx       # タスク2.4
```

### 変更ファイル
```
convex/
├── schema.ts                            # タスク1.4（スキーマ追加）
├── noodles.ts                          # タスク1.1
├── likes.ts                            # タスク2.1
├── comments.ts                         # タスク2.1
└── follows.ts                          # タスク2.1

src/
├── app/
│   └── (main)/
│       ├── noodles/page.tsx            # タスク1.2
│       ├── page.tsx                     # タスク1.3
│       └── layout.tsx                   # タスク2.4
└── components/
    └── layout/
        └── header.tsx                   # タスク2.3
```

---

## 🧪 テスト計画

### 統合テスト項目

#### 検索・フィルタ機能
1. ✅ 複数フィルタの組み合わせが正しく動作
2. ✅ フィルタクリアですべてリセット
3. ✅ ページネーションとフィルタの併用
4. ✅ マイページとタイムラインで同じフィルタが動作

#### 通知機能
1. ✅ いいね→通知作成→通知一覧表示→既読
2. ✅ コメント→通知作成→通知一覧表示→既読
3. ✅ フォロー→通知作成→通知一覧表示→既読
4. ✅ 自分へのアクションで通知が作成されないこと
5. ✅ 未読バッジが正しく表示・更新されること

---

## 🚀 実装順序（推奨）

### フェーズ1: バックエンド基盤（30分）
1. タスク1.1: 検索フィルタ拡張
2. タスク2.1: 通知自動生成

### フェーズ2: フロントエンドUI（60分）
並行実行:
- タスク1.2: タイムライン検索UI
- タスク1.3: マイページ検索UI
- タスク2.2: 通知センターUI
- タスク2.3: ヘッダー通知バッジ

### フェーズ3: 統合テスト（30分）
- エージェント統括者による動作確認
- バグ修正

### フェーズ4: オプション機能（30分）
- タスク1.4: 保存検索条件
- タスク2.4: リアルタイム通知トースト

---

## 📝 各エージェントへの指示

### Agent-Backend-1（タスク1.1）
**コンテキスト**:
- `convex/schema.ts`: スキーマ定義
- `convex/noodles.ts`: 既存クエリ実装
- `convex/shops.ts`: 店舗テーブル（prefectureフィールドあり）

**タスク**: `convex/noodles.ts` の `list` と `getByUser` クエリを拡張し、都道府県・評価・日付範囲フィルタを追加せよ。

---

### Agent-Frontend-1（タスク1.2）
**コンテキスト**:
- `src/app/(main)/noodles/page.tsx`: タイムラインページ
- `src/components/ui/prefecture-select.tsx`: 都道府県選択UI
- タスク1.1の完了を待つこと

**タスク**: タイムラインページのフィルタUIに、都道府県・評価・日付範囲フィルタを追加せよ。

---

### Agent-Frontend-2（タスク1.3）
**コンテキスト**:
- `src/app/(main)/page.tsx`: マイページ
- `src/app/(main)/noodles/page.tsx`: フィルタUIの参考実装
- タスク1.1の完了を待つこと

**タスク**: マイページの「啜ったラーメン」セクションに簡易検索・フィルタUIを追加せよ。

---

### Agent-Backend-2（タスク1.4、オプション）
**コンテキスト**:
- `convex/schema.ts`: スキーマ定義
- 既存の他のテーブル実装を参考にせよ

**タスク**: 検索条件を保存する `savedSearches` テーブルとCRUD操作を実装せよ。

---

### Agent-Backend-3（タスク2.1）
**コンテキスト**:
- `convex/notifications.ts`: 通知作成API
- `convex/likes.ts`: いいね機能
- `convex/comments.ts`: コメント機能
- `convex/follows.ts`: フォロー機能

**タスク**: いいね・コメント・フォロー時に自動で通知を作成する処理を追加せよ。

---

### Agent-Frontend-3（タスク2.2）
**コンテキスト**:
- `convex/notifications.ts`: 通知API
- `src/app/(main)/follow-requests/page.tsx`: 似たUIの参考実装
- `src/components/features/noodle-card.tsx`: カードデザインの参考
- タスク2.1の完了を待つこと

**タスク**: 通知一覧ページとコンポーネントを新規作成せよ。

---

### Agent-Frontend-4（タスク2.3）
**コンテキスト**:
- `src/components/layout/header.tsx`: ヘッダー実装
- `convex/notifications.ts`: 未読数取得API
- タスク2.1の完了を待つこと

**タスク**: ヘッダーに通知アイコンと未読バッジを追加せよ。

---

### Agent-Frontend-5（タスク2.4、オプション）
**コンテキスト**:
- Radix UIの Toast コンポーネント
- Convexのリアルタイム機能
- タスク2.2/2.3の完了を待つこと

**タスク**: リアルタイム通知トーストを実装し、レイアウトに組み込め。

---

## ✅ 完了基準

### 機能1: 検索・フィルタ
- [ ] 都道府県でフィルタできる
- [ ] 評価でフィルタできる
- [ ] 日付範囲でフィルタできる
- [ ] 複数フィルタの組み合わせが動作する
- [ ] マイページでも検索できる
- [ ] フィルタクリアが正常動作する

### 機能2: 通知
- [ ] いいね時に通知が届く
- [ ] コメント時に通知が届く
- [ ] フォロー時に通知が届く
- [ ] 通知一覧ページで確認できる
- [ ] ヘッダーに未読バッジが表示される
- [ ] 全て既読機能が動作する
- [ ] 通知から該当ページに遷移できる

---

## 🎉 期待効果

### 検索・フィルタ機能
- **投稿発見率 +30%**: ユーザーが見たい投稿を簡単に見つけられる
- **滞在時間 +20%**: 探索体験の向上
- **リピート率 +15%**: 過去の投稿を振り返りやすくなる

### 通知機能
- **エンゲージメント +40%**: 他ユーザーとのインタラクション促進
- **リテンション +25%**: 通知による再訪問
- **いいね/コメント数 +35%**: アクションへの反応が見えるため

---

## 📞 質問・不明点

各エージェントは実装中に不明点があれば、統括エージェント（Engineering Manager）に質問すること。

**連絡方法**: このドキュメントのコメントまたはプロジェクトチャット

---

**作成日**: 2025-12-12
**更新日**: 2025-12-12
**バージョン**: 1.0
