# 都道府県制覇機能 設計書

## 概要

ユーザーがラーメン店を訪問した際に都道府県を記録し、47都道府県の制覇状況を可視化する機能。

---

## 1. データ設計

### 1.1 shopsテーブルへの追加フィールド

```typescript
// convex/schema.ts
shops: defineTable({
  name: v.string(),
  address: v.optional(v.string()),
  prefecture: v.optional(v.string()),  // 追加: "tokyo", "osaka" など
})
```

### 1.2 都道府県マスタ

```typescript
// src/lib/constants/prefectures.ts
export const PREFECTURES = [
  { code: "hokkaido", name: "北海道", region: "hokkaido" },
  { code: "aomori", name: "青森県", region: "tohoku" },
  { code: "iwate", name: "岩手県", region: "tohoku" },
  // ... 全47都道府県
] as const;

export const REGIONS = [
  { code: "hokkaido", name: "北海道" },
  { code: "tohoku", name: "東北" },
  { code: "kanto", name: "関東" },
  { code: "chubu", name: "中部" },
  { code: "kinki", name: "近畿" },
  { code: "chugoku", name: "中国" },
  { code: "shikoku", name: "四国" },
  { code: "kyushu", name: "九州・沖縄" },
] as const;
```

### 1.3 都道府県バッジテーブル

```typescript
// convex/schema.ts
prefectureBadges: defineTable({
  userId: v.id("users"),
  prefecture: v.string(),        // "tokyo", "osaka" など
  tier: v.string(),              // "bronze" | "silver" | "gold"
  visitCount: v.number(),        // 訪問店舗数
  earnedAt: v.number(),          // 獲得日時
  updatedAt: v.number(),         // 更新日時
})
  .index("by_userId", ["userId"])
  .index("by_userId_prefecture", ["userId", "prefecture"])
```

---

## 2. バッジシステム

### 2.1 獲得条件

| ティア | 条件 | 表示色 |
|--------|------|--------|
| Bronze | 1店舗以上 | #CD7F32 |
| Silver | 5店舗以上 | #C0C0C0 |
| Gold | 10店舗以上 | #FFD700 |

### 2.2 バッジデザインコンセプト

**スタイル**: モダン＆ポップ
- 丸型アイコン（60x60px基準）
- 各県の名物・シンボルをシンプルなイラストで表現
- グラデーション背景（県ごとに異なる配色）
- ティアに応じた枠線色（Bronze/Silver/Gold）

### 2.3 47都道府県バッジ一覧

| 都道府県 | シンボル | カラー（メイン/サブ） |
|---------|---------|---------------------|
| 北海道 | 雪の結晶 + クマ | #4ECDC4 / #1A535C |
| 青森 | りんご | #FF6B6B / #C92A2A |
| 岩手 | わんこそば | #845EF7 / #5F3DC4 |
| 宮城 | 伊達政宗の兜 | #339AF0 / #1864AB |
| 秋田 | なまはげ | #F06595 / #C2255C |
| 山形 | さくらんぼ | #FF8787 / #E03131 |
| 福島 | 赤べこ | #FA5252 / #C92A2A |
| 茨城 | 納豆 | #BE4BDB / #9C36B5 |
| 栃木 | いちご | #FF6B6B / #FA5252 |
| 群馬 | だるま | #FF922B / #E8590C |
| 埼玉 | 草加せんべい | #FFD43B / #F59F00 |
| 千葉 | 落花生 | #94D82D / #66A80F |
| 東京 | 東京タワー | #FF6B6B / #FA5252 |
| 神奈川 | 赤レンガ倉庫 | #339AF0 / #1C7ED6 |
| 新潟 | 米・稲穂 | #8CE99A / #51CF66 |
| 富山 | ホタルイカ | #74C0FC / #4DABF7 |
| 石川 | 金箔 | #FFD43B / #FAB005 |
| 福井 | 恐竜 | #69DB7C / #40C057 |
| 山梨 | ぶどう | #B197FC / #9775FA |
| 長野 | りんご + 山 | #FF8787 / #4ECDC4 |
| 岐阜 | 白川郷 | #63E6BE / #38D9A9 |
| 静岡 | 富士山 + お茶 | #74C0FC / #69DB7C |
| 愛知 | しゃちほこ | #FFD43B / #F59F00 |
| 三重 | 伊勢海老 | #FF8787 / #FA5252 |
| 滋賀 | 琵琶湖 | #74C0FC / #339AF0 |
| 京都 | 五重塔 | #E599F7 / #BE4BDB |
| 大阪 | たこ焼き | #FF922B / #FD7E14 |
| 兵庫 | 神戸牛 | #E8590C / #D9480F |
| 奈良 | 鹿 | #94D82D / #74B816 |
| 和歌山 | みかん | #FF922B / #FD7E14 |
| 鳥取 | 砂丘 | #F8E3A3 / #E9ECEF |
| 島根 | 出雲大社 | #E599F7 / #DA77F2 |
| 岡山 | 桃太郎 | #FFC9C9 / #FF8787 |
| 広島 | もみじ饅頭 | #FF6B6B / #FA5252 |
| 山口 | ふぐ | #74C0FC / #4DABF7 |
| 徳島 | 阿波踊り | #F783AC / #E64980 |
| 香川 | うどん | #FFE066 / #FFD43B |
| 愛媛 | みかん | #FF922B / #FD7E14 |
| 高知 | カツオ | #339AF0 / #1C7ED6 |
| 福岡 | 明太子 | #FF6B6B / #FA5252 |
| 佐賀 | 有田焼 | #339AF0 / #74C0FC |
| 長崎 | カステラ | #FFD43B / #FCC419 |
| 熊本 | くまモン | #212529 / #FF6B6B |
| 大分 | 温泉 | #74C0FC / #ADB5BD |
| 宮崎 | マンゴー | #FF922B / #FF8787 |
| 鹿児島 | 桜島 | #868E96 / #495057 |
| 沖縄 | シーサー | #20C997 / #12B886 |

---

## 3. UI設計

### 3.1 投稿フォーム（都道府県選択）

```
┌─────────────────────────────────────┐
│ 店舗名 *                            │
│ [ラーメン次郎 渋谷店          ▼]   │
├─────────────────────────────────────┤
│ 都道府県                            │
│ [東京都                        ▼]   │
│  ├─ 北海道・東北 ────────────────   │
│  │   北海道  青森県  岩手県...      │
│  ├─ 関東 ──────────────────────    │
│  │   茨城県  栃木県  群馬県...      │
│  └─ ...                             │
└─────────────────────────────────────┘
```

- 地方別にグループ化したドロップダウン
- 店舗に紐づいている場合は自動入力

### 3.2 日本地図UI（制覇マップ）

#### コンパクト版（マイページ・ユーザープロフィール）

```
┌─────────────────────────────────────┐
│ 🗾 制覇マップ          [12/47県]   │
├─────────────────────────────────────┤
│                                     │
│      [日本地図 SVG]                 │
│      - 未訪問: グレー(#E9ECEF)     │
│      - Bronze: 銅色(#CD7F32)       │
│      - Silver: 銀色(#C0C0C0)       │
│      - Gold  : 金色(#FFD700)       │
│                                     │
│         タップで詳細ページへ →      │
└─────────────────────────────────────┘
```

- サイズ: 約300x200px
- インタラクション: タップで詳細ページへ遷移

#### フル版（専用ページ /map）

```
┌─────────────────────────────────────┐
│ ← 制覇マップ                        │
├─────────────────────────────────────┤
│                                     │
│      [大きな日本地図 SVG]           │
│                                     │
│      各県タップ → 詳細表示         │
│                                     │
├─────────────────────────────────────┤
│ 統計                                │
│ ┌─────┬─────┬─────┬─────┐          │
│ │ 制覇 │Bronze│Silver│ Gold│        │
│ │ 12県 │  8県 │  3県 │ 1県 │        │
│ └─────┴─────┴─────┴─────┘          │
├─────────────────────────────────────┤
│ 地方別                              │
│ 北海道・東北 [████░░░░] 3/7        │
│ 関東        [████████] 7/7 🎉      │
│ 中部        [██░░░░░░] 2/9        │
│ ...                                 │
├─────────────────────────────────────┤
│ バッジコレクション                  │
│ [🏅東京][🏅神奈川][🥉大阪]...      │
└─────────────────────────────────────┘
```

- 各県タップで詳細モーダル表示
- 詳細モーダル: 県名、訪問店舗数、バッジ、訪問店舗リスト

### 3.3 都道府県詳細モーダル

```
┌─────────────────────────────────────┐
│              ✕                      │
│                                     │
│         [東京バッジ Gold]           │
│           🗼 東京都                 │
│                                     │
│         ★★★★★ Gold達成！          │
│         訪問店舗: 15店              │
│                                     │
├─────────────────────────────────────┤
│ 訪問した店舗                        │
│ ・ラーメン次郎 渋谷店 (3杯)        │
│ ・一蘭 新宿店 (2杯)                │
│ ・麺屋武蔵 池袋店 (1杯)            │
│ ...                                 │
└─────────────────────────────────────┘
```

---

## 4. API設計

### 4.1 Convex Functions

```typescript
// convex/prefectures.ts

// ユーザーの都道府県別訪問状況を取得
export const getVisitStats = query({
  args: { userId: v.id("users") },
  handler: async (ctx, args) => {
    // 全訪問データを集計して返す
  },
});

// 特定都道府県の詳細情報を取得
export const getPrefectureDetail = query({
  args: {
    userId: v.id("users"),
    prefecture: v.string(),
  },
  handler: async (ctx, args) => {
    // 訪問店舗リスト、バッジ情報を返す
  },
});

// バッジ獲得/更新処理（投稿時に呼び出し）
export const checkAndUpdateBadge = mutation({
  args: {
    userId: v.id("users"),
    prefecture: v.string(),
  },
  handler: async (ctx, args) => {
    // 訪問数をカウントしてバッジを更新
  },
});
```

---

## 5. 実装フェーズ

### Phase 1: 基盤構築（推定作業量: 中）
- [ ] 都道府県マスタ作成 (`src/lib/constants/prefectures.ts`)
- [ ] DBスキーマ更新 (`convex/schema.ts`)
- [ ] 投稿フォームに都道府県選択UI追加

### Phase 2: バッジシステム（推定作業量: 中）
- [ ] prefectureBadgesテーブル作成
- [ ] バッジ判定ロジック実装 (`convex/prefectures.ts`)
- [ ] 投稿完了時のバッジ更新処理

### Phase 3: 日本地図UI（推定作業量: 大）
- [ ] SVG日本地図コンポーネント作成
- [ ] コンパクト版（マイページ用）
- [ ] フル版（専用ページ）
- [ ] 都道府県詳細モーダル

### Phase 4: バッジデザイン（推定作業量: 大）
- [ ] 47都道府県のSVGアイコン作成
- [ ] ティア別デザインバリエーション
- [ ] バッジコレクション表示UI

---

## 6. 注意事項

### パフォーマンス
- 日本地図SVGは軽量化必須（gzip後50KB以下目標）
- 訪問統計はキャッシュ活用を検討

### アクセシビリティ
- 色だけでなくアイコン形状でもティアを区別
- 地図のalt属性、スクリーンリーダー対応

### 将来拡張
- 地方制覇バッジ（全国8地方）
- 全国制覇バッジ
- 期間限定イベント（夏休み制覇チャレンジなど）
