# ラーメン記録アプリ 要件定義書

**作成日:** 2025年12月6日
**バージョン:** 1.0
**作成方法:** リバースエンジニアリングによる既存コードからの抽出

---

## 1. 概要

### 1.1 システム名
ラーメン記録・共有プラットフォーム

### 1.2 システム概要
ユーザーがラーメン店の訪問記録を登録・管理し、他ユーザーと共有できるWebアプリケーション。お気に入り機能により、気になるラーメン記録をブックマークできる。

### 1.3 目的
- ラーメン愛好家が訪問した店舗・メニューを記録・管理できる
- コミュニティ内でラーメン情報を共有・発見できる
- お気に入り機能で気になる店舗を保存できる

---

## 2. 機能要件

### 2.1 ユーザー管理機能

#### 2.1.1 ユーザー登録・ログイン
| 項目 | 内容 |
|------|------|
| 機能ID | F-001 |
| 機能名 | ユーザー認証 |
| 概要 | Clerkによるユーザー登録・ログイン |
| 認証方式 | Clerk（メール/パスワード、ソーシャルログイン対応） |
| 処理 | Clerkが認証を管理、初回ログイン時にConvexへユーザー情報を同期 |
| 出力 | 認証成功時：マイページへ遷移 |
| 制約 | Clerkのミドルウェアで認証状態を管理 |

#### 2.1.2 ログアウト
| 項目 | 内容 |
|------|------|
| 機能ID | F-002 |
| 機能名 | ログアウト |
| 概要 | ログイン中のユーザーがシステムからログアウトする |
| 処理 | Clerk SignOutButtonでセッション終了 |
| 出力 | ログインページへ遷移 |

#### 2.1.3 マイページ表示
| 項目 | 内容 |
|------|------|
| 機能ID | F-003 |
| 機能名 | マイページ表示 |
| 概要 | ログインユーザーの個人ダッシュボードを表示 |
| 表示内容 | 自分が投稿したラーメン記録一覧、ランク、獲得バッジ |
| 実装 | Convex useQuery でリアルタイム取得 |
| 制約 | Clerkミドルウェアで認証必須 |

---

### 2.2 ラーメン記録管理機能

#### 2.2.1 ラーメン記録一覧表示
| 項目 | 内容 |
|------|------|
| 機能ID | F-005 |
| 機能名 | ラーメン記録一覧表示 |
| 概要 | 全ユーザーのラーメン記録を一覧表示する |
| 表示項目 | 投稿者名、店名、商品名、ジャンル、評価、コメント |
| 検索・フィルタ | ジャンル選択（複数可）、店名検索（部分一致・即時フィルタ）、商品名検索（部分一致・即時フィルタ） |
| ソート | 新着順（デフォルト）、評価順、訪問日順 |
| 制約 | ログイン必須 |

#### 2.2.2 ラーメン記録詳細表示
| 項目 | 内容 |
|------|------|
| 機能ID | F-006 |
| 機能名 | ラーメン記録詳細表示 |
| 概要 | 個別のラーメン記録の詳細情報を表示する |
| 表示項目 | 店名、商品名、ジャンル、訪問日、コメント、評価（星表示）、投稿者名 |
| アクション | 自分の記録：編集・削除ボタン表示、他者の記録：お気に入りボタン表示 |
| 制約 | ログイン必須 |

#### 2.2.3 ラーメン記録新規作成
| 項目 | 内容 |
|------|------|
| 機能ID | F-007 |
| 機能名 | ラーメン記録新規作成 |
| 概要 | 新しいラーメン記録を登録する |
| 入力項目 | 店舗（必須・検索選択式）、商品名（必須）、ジャンル（必須・複数選択可）、訪問日（任意）、コメント（任意）、評価（1-5、任意・未評価はnull） |
| ジャンル選択肢 | 醤油、塩、味噌、とんこつ、家系、二郎系、魚介、煮干し、つけ麺、担々麺、鶏白湯、その他（複数選択可：例「魚介とんこつ」） |
| 処理 | ログインユーザーのIDを自動設定して保存 |
| 出力 | 作成成功時：詳細ページへ遷移 |
| 制約 | ログイン必須 |

#### 2.2.4 ラーメン記録編集
| 項目 | 内容 |
|------|------|
| 機能ID | F-008 |
| 機能名 | ラーメン記録編集 |
| 概要 | 既存のラーメン記録を編集する |
| 入力項目 | 店舗（必須・検索選択式）、商品名（必須）、ジャンル（必須・複数選択可）、訪問日（任意）、コメント（任意）、評価（1-5、任意・未評価はnull） |
| 出力 | 更新成功時：詳細ページへ遷移 |
| 制約 | ログイン必須、自分の記録のみ編集可能 |

#### 2.2.5 ラーメン記録削除
| 項目 | 内容 |
|------|------|
| 機能ID | F-009 |
| 機能名 | ラーメン記録削除 |
| 概要 | 既存のラーメン記録を削除する |
| 処理 | 確認ダイアログ表示後、削除実行 |
| 出力 | 削除成功時：一覧ページへ遷移 |
| 制約 | ログイン必須、自分の記録のみ削除可能 |

---

### 2.3 お気に入り機能

#### 2.3.1 お気に入り登録
| 項目 | 内容 |
|------|------|
| 機能ID | F-010 |
| 機能名 | お気に入り登録 |
| 概要 | 他ユーザーのラーメン記録をお気に入りに追加する |
| 処理 | ユーザーIDとラーメン記録IDの組み合わせを保存 |
| 制約 | ログイン必須、自分の記録はお気に入り不可、同一記録の重複登録不可 |

#### 2.3.2 お気に入り解除
| 項目 | 内容 |
|------|------|
| 機能ID | F-011 |
| 機能名 | お気に入り解除 |
| 概要 | お気に入りに登録したラーメン記録を解除する |
| 処理 | 該当するお気に入りレコードを削除 |
| 制約 | ログイン必須 |

#### 2.3.3 お気に入り一覧表示
| 項目 | 内容 |
|------|------|
| 機能ID | F-012 |
| 機能名 | お気に入り一覧表示 |
| 概要 | ログインユーザーがお気に入り登録したラーメン記録を一覧表示する |
| 表示項目 | 投稿者名、店名、商品名、ジャンル、評価、コメント |
| 制約 | ログイン必須 |

---

## 3. 非機能要件

### 3.1 セキュリティ要件
| 項目 | 内容 |
|------|------|
| 認証基盤 | Clerk（パスワード管理・セッション管理を委譲） |
| 認証方式 | Clerk JWT + Convex認証統合 |
| 認可制御 | Convex mutation/query内でユーザーID検証、自分のリソースのみ編集・削除可能 |
| アクセス制御 | Next.js middleware + Clerkで未認証ユーザーをリダイレクト |

### 3.2 ユーザビリティ要件
| 項目 | 内容 |
|------|------|
| 対象デバイス | スマートフォン（モバイルファースト） |
| 言語 | 日本語（UIラベル、エラーメッセージ、日付フォーマット） |
| 日付形式 | YYYY/MM/DD（日本式） |
| レスポンシブ | 対応（モバイル優先） |

### 3.3 スマートフォンUX要件
| 項目 | 内容 |
|------|------|
| タッチ操作 | タップ・スワイプに最適化したUI |
| 入力補助 | 店舗名オートコンプリート（過去入力・マスタから候補表示） |
| 即時フィルタ | 検索入力中にリアルタイムで結果を絞り込み |
| 最小タップ数 | 主要操作は3タップ以内で完了 |
| フォーム最適化 | 適切なinput type（email, date等）でキーボード最適化 |

---

## 4. データモデル

### 4.1 Convexスキーマ概要

```
// convex/schema.ts

┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   users     │       │    shops    │       │    likes    │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ _id (Id)    │       │ _id (Id)    │       │ _id (Id)    │
│ clerkId     │       │ name        │       │ userId      │←─┐
│ name        │       │ _creationTime│      │ noodleId    │  │
│ email       │       └─────────────┘       │ _creationTime│ │
│ imageUrl    │              │              └─────────────┘  │
│ deletedAt   │              ↓                               │
│ _creationTime│      ┌─────────────┐                        │
└─────────────┘       │   noodles   │                        │
      │               ├─────────────┤                        │
      │               │ _id (Id)    │────────────────────────┘
      └──────────────→│ userId      │
                      │ shopId      │←── shops._id
                      │ ramenName   │
                      │ genres      │ (string[])
                      │ visitDate   │ (number/timestamp)
                      │ comment     │
                      │ evaluation  │ (number | undefined)
                      │ _creationTime│
                      └─────────────┘
```

**注記:** Convexでは`_id`と`_creationTime`は自動生成。外部キーはId型で参照。

### 4.2 Convexスキーマ定義

#### 4.2.1 users（ユーザー）
| フィールド | Convex型 | 必須 | 説明 |
|-----------|---------|------|------|
| _id | Id<"users"> | 自動 | 主キー（Convex自動生成） |
| clerkId | v.string() | YES | Clerk ユーザーID |
| name | v.string() | YES | ユーザー名（Clerkから同期） |
| email | v.string() | YES | メールアドレス（Clerkから同期） |
| imageUrl | v.optional(v.string()) | NO | プロフィール画像URL |
| deletedAt | v.optional(v.number()) | NO | 論理削除タイムスタンプ |
| _creationTime | number | 自動 | 作成日時（Convex自動生成） |

#### 4.2.2 shops（店舗マスタ）
| フィールド | Convex型 | 必須 | 説明 |
|-----------|---------|------|------|
| _id | Id<"shops"> | 自動 | 主キー |
| name | v.string() | YES | 店舗名 |
| _creationTime | number | 自動 | 作成日時 |

**インデックス:** `by_name` (name) - 店舗名検索用

#### 4.2.3 noodles（ラーメン記録）
| フィールド | Convex型 | 必須 | 説明 |
|-----------|---------|------|------|
| _id | Id<"noodles"> | 自動 | 主キー |
| userId | v.id("users") | YES | 投稿者ID |
| shopId | v.id("shops") | YES | 店舗ID |
| ramenName | v.string() | YES | 商品名 |
| genres | v.array(v.string()) | YES | ジャンル（複数選択） |
| visitDate | v.optional(v.number()) | NO | 訪問日（タイムスタンプ） |
| comment | v.optional(v.string()) | NO | コメント |
| evaluation | v.optional(v.number()) | NO | 評価（1-5、未評価はundefined） |
| _creationTime | number | 自動 | 作成日時 |

**インデックス:** `by_userId`, `by_shopId`, `by_creationTime`

#### 4.2.4 likes（お気に入り）
| フィールド | Convex型 | 必須 | 説明 |
|-----------|---------|------|------|
| _id | Id<"likes"> | 自動 | 主キー |
| userId | v.id("users") | YES | ユーザーID |
| noodleId | v.id("noodles") | YES | ラーメン記録ID |
| _creationTime | number | 自動 | 作成日時 |

**インデックス:** `by_userId_noodleId` (userId, noodleId) - 重複防止・検索用

### 4.3 リレーション
| 関係 | 説明 |
|------|------|
| User has_many Noodles | 1人のユーザーは複数のラーメン記録を持つ |
| User has_many Likes | 1人のユーザーは複数のお気に入りを持つ |
| User has_many like_noodles through Likes | 中間テーブル経由でお気に入りラーメンを取得 |
| Shop has_many Noodles | 1つの店舗は複数のラーメン記録を持つ |
| Noodle belongs_to User | ラーメン記録は1人のユーザーに属する |
| Noodle belongs_to Shop | ラーメン記録は1つの店舗に属する |
| Noodle has_many Likes | 1つのラーメン記録は複数のお気に入りを持つ |
| Like belongs_to User | お気に入りは1人のユーザーに属する |
| Like belongs_to Noodle | お気に入りは1つのラーメン記録に属する |

### 4.4 アカウント削除時の挙動
| 対象 | 挙動 |
|------|------|
| users | deleted_atに日時を設定（論理削除） |
| noodles | 削除しない（投稿データは残る） |
| likes | 削除しない |

---

## 5. 画面一覧（Next.js App Router）

| 画面ID | 画面名 | パス | ファイル | 概要 |
|--------|--------|-----|----------|------|
| S-001 | 認証画面 | /sign-in, /sign-up | Clerk組み込み | Clerk SignIn/SignUpコンポーネント |
| S-002 | マイページ | / | app/page.tsx | ユーザーダッシュボード |
| S-003 | ラーメン記録一覧 | /noodles | app/noodles/page.tsx | 全記録一覧（検索機能付き） |
| S-004 | ラーメン記録詳細 | /noodles/[id] | app/noodles/[id]/page.tsx | 記録詳細表示 |
| S-005 | ラーメン記録新規作成 | /noodles/new | app/noodles/new/page.tsx | 新規記録フォーム |
| S-006 | ラーメン記録編集 | /noodles/[id]/edit | app/noodles/[id]/edit/page.tsx | 記録編集フォーム |
| S-007 | お気に入り一覧 | /likes | app/likes/page.tsx | お気に入り記録一覧 |
| S-008 | ランキング | /ranking | app/ranking/page.tsx | ユーザーランキング |

---

## 6. Convex Functions一覧

### 6.1 Query（データ取得）
| 関数名 | ファイル | 説明 |
|--------|----------|------|
| users.getByClerkId | convex/users.ts | ClerkIDからユーザー取得 |
| users.getCurrent | convex/users.ts | 現在のユーザー情報取得 |
| noodles.list | convex/noodles.ts | 記録一覧取得（フィルタ・ソート対応） |
| noodles.getById | convex/noodles.ts | 記録詳細取得 |
| noodles.getByUser | convex/noodles.ts | ユーザーの記録一覧 |
| shops.list | convex/shops.ts | 店舗一覧取得 |
| shops.search | convex/shops.ts | 店舗名検索（オートコンプリート用） |
| likes.getByUser | convex/likes.ts | ユーザーのお気に入り一覧 |
| likes.isLiked | convex/likes.ts | お気に入り済みか確認 |
| badges.getByUser | convex/badges.ts | ユーザーの獲得バッジ一覧 |
| ranking.getShopVisits | convex/ranking.ts | 訪問店舗数ランキング |

### 6.2 Mutation（データ更新）
| 関数名 | ファイル | 説明 |
|--------|----------|------|
| users.upsert | convex/users.ts | ユーザー作成/更新（Clerk連携） |
| users.softDelete | convex/users.ts | ユーザー論理削除 |
| noodles.create | convex/noodles.ts | 記録作成 |
| noodles.update | convex/noodles.ts | 記録更新 |
| noodles.remove | convex/noodles.ts | 記録削除 |
| shops.getOrCreate | convex/shops.ts | 店舗取得または作成 |
| likes.toggle | convex/likes.ts | お気に入り登録/解除 |
| badges.checkAndAward | convex/badges.ts | バッジ獲得条件チェック・付与 |

### 6.3 Next.js API Routes（Webhook用）
| エンドポイント | ファイル | 説明 |
|---------------|----------|------|
| POST /api/webhooks/clerk | app/api/webhooks/clerk/route.ts | Clerkユーザー同期Webhook |

---

## 7. バリデーションルール（Convex + Zod）

### 7.1 User（ユーザー）
| フィールド | ルール | 備考 |
|-----------|--------|------|
| clerkId | 必須、string | Clerkから自動取得 |
| name | 必須、string | Clerkから同期 |
| email | 必須、string、email形式 | Clerkから同期 |

### 7.2 Shop（店舗）
| フィールド | ルール | 備考 |
|-----------|--------|------|
| name | 必須、string、1-100文字 | インデックスで重複チェック |

### 7.3 Noodle（ラーメン記録）
| フィールド | ルール | 備考 |
|-----------|--------|------|
| shopId | 必須、Id<"shops"> | Convex型で参照整合性 |
| ramenName | 必須、string、1-100文字 | - |
| genres | 必須、string[]、1つ以上 | ジャンルマスタ値のみ許可 |
| visitDate | optional、number | タイムスタンプ形式 |
| comment | optional、string、最大1000文字 | - |
| evaluation | optional、number、1-5 | undefinedで未評価 |

### 7.4 Like（お気に入り）
| フィールド | ルール | 備考 |
|-----------|--------|------|
| userId + noodleId | 複合インデックスで一意 | toggle時にチェック |

---

## 8. ジャンルマスタ

| コード | 表示名 |
|--------|--------|
| 醤油 | 醤油 |
| 塩 | 塩 |
| 味噌 | 味噌 |
| とんこつ | とんこつ |
| 家系 | 家系 |
| 二郎系 | 二郎系 |
| 魚介 | 魚介 |
| 煮干し | 煮干し |
| つけ麺 | つけ麺 |
| 担々麺 | 担々麺 |
| 鶏白湯 | 鶏白湯 |
| その他 | その他 |

---

## 9. 画面遷移図

```
[ログイン画面] ←────────────────────────────────────────┐
      │                                                │
      ├─→ [ユーザー登録画面] ─→ [マイページ]            │
      │                            │                   │
      └─→ [マイページ] ←───────────┘                   │
              │                                        │
              ├─→ [ラーメン記録一覧] ←─────────────────┤
              │         │                              │
              │         ├─→ [ラーメン記録詳細]          │
              │         │         │                    │
              │         │         ├─→ [編集画面] ──────┤
              │         │         │                    │
              │         │         └─→ [削除] ──────────┤
              │         │                              │
              │         └─→ [新規作成画面] ─────────────┤
              │                                        │
              ├─→ [お気に入り一覧]                      │
              │         │                              │
              │         └─→ [ラーメン記録詳細]          │
              │                                        │
              └─→ [ログアウト] ─────────────────────────┘
```

---

## 10. ゲーミフィケーション機能

### 10.1 ユーザーランク制度（麺位十二階）

訪問店舗数に応じてユーザーランクが決定される。ランクに応じてUIテーマカラーが変化。

| ランク | 称号 | 必要店舗数 | テーマカラー |
|--------|------|-----------|-------------|
| 1 | 麺見習い | 0 | グレー (#9E9E9E) |
| 2 | 麺徒 | 3 | ブラウン (#8D6E63) |
| 3 | 麺士 | 10 | グリーン (#66BB6A) |
| 4 | 麺師 | 25 | ブルー (#42A5F5) |
| 5 | 麺匠 | 50 | パープル (#AB47BC) |
| 6 | 麺豪 | 75 | オレンジ (#FFA726) |
| 7 | 麺聖 | 100 | レッド (#EF5350) |
| 8 | 麺仙 | 150 | シルバー (#B0BEC5) |
| 9 | 麺王 | 200 | ゴールド (#FFD54F) |
| 10 | 麺帝 | 300 | プラチナ (#E0E0E0) |
| 11 | 麺神 | 500 | ダイヤモンド (#81D4FA) |
| 12 | 麺極 | 1000 | レインボー (グラデーション) |

### 10.2 バッジ（称号）システム

投稿活動や特定条件達成でバッジを獲得。

#### デザイン仕様
| 項目 | 仕様 |
|------|------|
| コンポーネント | Radix UI Badge + Tailwind CSS カスタムスタイル |
| アニメーション | Framer Motion（獲得時のポップアップ・光彩エフェクト） |
| アイコン | Lucide React + カスタムSVG |
| レアリティ表現 | グラデーション背景、グロー効果、シャドウで差別化 |
| ツールチップ | Radix UI Tooltip（獲得条件・日時を表示） |

#### バッジレアリティ
| レアリティ | スタイル | 対象 |
|------------|----------|------|
| Common | 単色背景 (gray) | 投稿系（初期） |
| Uncommon | 単色背景 (green) | 投稿系（中級） |
| Rare | グラデーション背景 (blue) | 探索系 |
| Epic | グラデーション + グロー (purple) | ジャンル系 |
| Legendary | アニメーション付きグラデーション (gold) | 特殊・最上位 |

#### 投稿系バッジ
| バッジ名 | 条件 | アイコン | レアリティ |
|----------|------|----------|-----------|
| はじめの一杯 | 初投稿 | Soup (Lucide) | Common |
| 常連さん | 10投稿達成 | Home (Lucide) | Common |
| ラーメン通 | 50投稿達成 | FileText (Lucide) | Uncommon |
| 記録魔 | 100投稿達成 | Library (Lucide) | Rare |
| レジェンド | 500投稿達成 | Crown (Lucide) | Legendary |

#### 探索系バッジ
| バッジ名 | 条件 | アイコン | レアリティ |
|----------|------|----------|-----------|
| 冒険家 | 10店舗訪問 | Map (Lucide) | Uncommon |
| 開拓者 | 50店舗訪問 | Compass (Lucide) | Rare |
| 全国制覇 | 100店舗訪問 | Trophy (Lucide) | Epic |

#### ジャンル系バッジ
| バッジ名 | 条件 | アイコン | レアリティ |
|----------|------|----------|-----------|
| 醤油マスター | 醤油ラーメン20杯 | カスタムSVG | Epic |
| 塩の達人 | 塩ラーメン20杯 | カスタムSVG | Epic |
| 味噌職人 | 味噌ラーメン20杯 | カスタムSVG | Epic |
| とんこつ狂 | とんこつ20杯 | Bone (Lucide) | Epic |
| 家系信者 | 家系20杯 | Store (Lucide) | Epic |
| 二郎戦士 | 二郎系20杯 | Dumbbell (Lucide) | Epic |
| オールラウンダー | 全ジャンル制覇 | Rainbow (Lucide) | Legendary |

#### 特殊バッジ
| バッジ名 | 条件 | アイコン | レアリティ |
|----------|------|----------|-----------|
| 目利き | お気に入りされた数10回 | Eye (Lucide) | Rare |
| インフルエンサー | お気に入りされた数50回 | Star (Lucide) | Epic |
| 連続記録 | 7日連続投稿 | Flame (Lucide) | Legendary |

### 10.3 ユーザーランキング

#### ランキング種別
| 種別 | 集計基準 | 表示 |
|------|----------|------|
| 訪問店舗数ランキング | ユニーク店舗数 | 週間/月間/総合 |
| 投稿数ランキング | 総投稿数 | 週間/月間/総合 |
| 人気ユーザーランキング | 被お気に入り数 | 週間/月間/総合 |

### 10.4 Convexスキーマ追加

#### userBadges（ユーザーバッジ）
| フィールド | Convex型 | 説明 |
|-----------|---------|------|
| _id | Id<"userBadges"> | 主キー |
| userId | v.id("users") | ユーザーID |
| badgeCode | v.string() | バッジコード |
| acquiredAt | v.number() | 獲得タイムスタンプ |
| _creationTime | number | 作成日時 |

**インデックス:** `by_userId` (userId)

#### badges（バッジマスタ - 定数として定義）
```typescript
// lib/constants/badges.ts
export const BADGES = {
  FIRST_POST: {
    code: "first_post",
    name: "はじめの一杯",
    description: "初めての投稿",
    icon: "Soup",
    rarity: "common",
    conditionType: "post_count",
    conditionValue: 1,
  },
  // ...
} as const;
```

---

## 11. 将来拡張候補（現時点では未実装）

以下は将来的に追加が検討される可能性のある機能：

1. **画像アップロード機能** - Convex File Storage でラーメン写真をアップロード
2. **ユーザープロフィール編集** - Clerk UserProfile コンポーネント活用
3. **コメント機能** - 他ユーザーの記録にコメント投稿
4. **フォロー機能** - ユーザー間のフォロー関係
5. **地図連携** - 店舗の位置情報表示（Google Maps API）
6. **SNS共有** - Twitter/Instagram等への共有（Web Share API）
7. **プッシュ通知** - お気に入り登録時の通知（PWA対応）
8. **管理者機能** - 不適切な投稿の管理（Clerk Organization活用）
9. **PWA対応** - オフライン対応、ホーム画面追加

---

*本文書は要件定義として作成されました。実装との差異がある場合は、コードを正とします。*
